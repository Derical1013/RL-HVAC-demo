<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>RL-HVAC Battery Arbitrage Demo</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .dashboard { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); display: flex; gap: 30px; max-width: 1300px; width: 100%; }
        
        .control-view { width: 400px; display: flex; flex-direction: column; align-items: center; border-right: 2px solid #eee; padding-right: 30px; }
        .charts-view { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        
        canvas { border: 1px solid #ccc; background: #fdfdfd; border-radius: 12px; margin-bottom: 20px; display: block; }
        
        h2 { font-size: 28px; margin-bottom: 20px; color: #222; }
        h3 { margin: 10px 0 5px 0; color: #444; font-size: 20px; }
        
        /* 状态卡片 */
        .status-card { width: 100%; background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 8px solid #ccc; transition: 0.3s; }
        .status-card.charge { border-left-color: #28a745; background: #e6f4ea; }
        .status-card.discharge { border-left-color: #dc3545; background: #ffe6e6; }
        .status-title { font-size: 14px; color: #666; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .status-text { font-size: 24px; font-weight: bold; margin: 5px 0; color: #333; }
        
        /* 时间滑块 */
        .slider-container { width: 100%; margin-top: 20px; }
        input[type=range] { width: 100%; height: 8px; border-radius: 5px; background: #ddd; outline: none; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #007bff; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .play-btn { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 15px; width: 100%; }
        .play-btn:hover { background: #0056b3; }
        
        .savings-box { text-align: center; margin-top: 10px; padding: 15px; background: #f0fff4; border: 1px solid #c3e6cb; border-radius: 10px; width: 100%; }
        .savings-counter { font-size: 36px; color: #28a745; font-weight: bold; font-family: monospace; }
        
        .legend { font-size: 14px; color: #666; display: flex; gap: 20px; margin-bottom: 5px; }
        .dot { width: 12px; height: 12px; display: inline-block; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
    </style>
</head>
<body>

    <h2>RL-HVAC Intelligent Storage Arbitrage Demo</h2>
    <div class="dashboard">
        <div class="control-view">
            <div id="statusCard" class="status-card">
                <div class="status-title">Current Strategy</div>
                <div class="status-text" id="strategyText">IDLE</div>
                <div style="font-size: 16px; color:#555; margin-top:5px;">Time: <span id="timeText" style="font-weight:bold;">00:00</span></div>
            </div>

            <canvas id="batteryCanvas" width="300" height="280"></canvas>

            <div class="savings-box">
                <div style="font-size:14px; color:#155724; font-weight:bold;">TOTAL COST SAVED</div>
                <div class="savings-counter">$<span id="moneyText">0.00</span></div>
            </div>

            <div class="slider-container">
                <input type="range" min="0" max="23.9" step="0.1" value="0" id="timeSlider">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#888; margin-top:5px;">
                    <span>00:00</span><span>12:00</span><span>23:59</span>
                </div>
            </div>
            <button class="play-btn" id="playBtn" onclick="togglePlay()">Pause Simulation</button>
        </div>

        <div class="charts-view">
            <h3>1. Electricity Price ($/kWh) - The Signal</h3>
            <div class="legend">
                <span><span class="dot" style="background:#e6f4ea; border:1px solid #28a745"></span>Cheap Zone (Charge)</span>
                <span><span class="dot" style="background:#ffe6e6; border:1px solid #dc3545"></span>Peak Zone (Discharge)</span>
            </div>
            <canvas id="priceCanvas" width="800" height="180"></canvas>

            <h3>2. Grid Load (kW) - The Result</h3>
            <div class="legend">
                <span><span class="dot" style="background:#bbb; border:1px dashed #666"></span>Original Load (No Battery)</span>
                <span><span class="dot" style="background:#007bff"></span>Optimized Grid Load</span>
                <span><span class="dot" style="background:orange"></span>Peak Shaved</span>
            </div>
            <canvas id="loadCanvas" width="800" height="250"></canvas>
        </div>
    </div>

    <script>
        // --- 1. 数据生成 (模拟一天) ---
        const HOURS = 24;
        const RESOLUTION = 10; 
        const TOTAL_POINTS = HOURS * RESOLUTION;
        
        let priceData = [];
        let loadData = [];
        let batterySOC = []; 
        let gridLoad = [];
        let savingsHistory = [];
        let moneySaved = 0;
        let currentSOC = 0.2; // 20% 初始电量

        // 生成基础数据
        for(let i=0; i<TOTAL_POINTS; i++) {
            let h = i / RESOLUTION;
            
            // 电价：0-6点低(0.1), 6-14点中(0.2), 14-20点高(0.5), 20-24点中(0.2)
            let p = 0.2;
            if (h < 6) p = 0.1;
            else if (h >= 14 && h < 20) p = 0.5; // 尖峰时刻
            priceData.push(p);

            // 原始负荷：下午最热
            let base = 50;
            let peak = 120 * Math.exp(-Math.pow(h - 17, 2) / 12); 
            loadData.push(base + peak);
        }

        // 模拟 RL 策略运行
        for(let i=0; i<TOTAL_POINTS; i++) {
            let h = i / RESOLUTION;
            let p = priceData[i];
            let load = loadData[i];
            let action = 0; // +充电, -放电

            // [策略逻辑]
            // 1. 凌晨便宜：充电
            if (p < 0.15 && currentSOC < 0.9) {
                action = 30; 
            }
            // 2. 下午又贵又热：放电 (削峰)
            else if (p > 0.4 && load > 100 && currentSOC > 0.1) {
                action = -50; 
            }

            // 更新 SOC
            currentSOC += action / 600; 
            currentSOC = Math.max(0.1, Math.min(1.0, currentSOC));
            batterySOC.push(currentSOC);

            // 计算电网实际负荷 = 原始 + 充电 - 放电
            let net = load + action;
            gridLoad.push(net);

            // 计算省钱
            let costOld = load * p;
            let costNew = net * p;
            moneySaved += (costOld - costNew) * 0.1; // 累积
            savingsHistory.push(moneySaved);
        }

        // --- 2. 动画控制 ---
        let currentIndex = 0;
        let isPlaying = true;
        
        const slider = document.getElementById('timeSlider');
        const playBtn = document.getElementById('playBtn');
        const statusCard = document.getElementById('statusCard');
        const strategyText = document.getElementById('strategyText');
        const timeText = document.getElementById('timeText');
        const moneyText = document.getElementById('moneyText');

        const batCtx = document.getElementById('batteryCanvas').getContext('2d');
        const priceCtx = document.getElementById('priceCanvas').getContext('2d');
        const loadCtx = document.getElementById('loadCanvas').getContext('2d');

        // 事件监听
        slider.addEventListener('input', (e) => {
            currentIndex = Math.floor(e.target.value * RESOLUTION);
            isPlaying = false;
            playBtn.innerText = "Resume Simulation";
            draw();
        });

        function togglePlay() {
            isPlaying = !isPlaying;
            playBtn.innerText = isPlaying ? "Pause Simulation" : "Resume Simulation";
        }

        // --- 3. 核心循环 ---
        function loop() {
            if (isPlaying) {
                currentIndex++;
                if (currentIndex >= TOTAL_POINTS) currentIndex = 0;
                slider.value = currentIndex / RESOLUTION;
                draw();
            }
            requestAnimationFrame(loop);
        }

        function draw() {
            let h = currentIndex / RESOLUTION;
            let soc = batterySOC[currentIndex];
            let net = gridLoad[currentIndex];
            let raw = loadData[currentIndex];
            let diff = net - raw; // 动作

            updateUI(h, diff, savingsHistory[currentIndex]);
            drawBattery(soc, diff);
            drawPriceChart(priceCtx, 800, 180);
            drawLoadChart(loadCtx, 800, 250);
        }

        function updateUI(h, diff, saved) {
            let hh = Math.floor(h);
            let mm = Math.floor((h - hh) * 60);
            timeText.innerText = `${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}`;
            moneyText.innerText = saved.toFixed(2);

            if (diff > 5) {
                statusCard.className = "status-card charge";
                strategyText.innerText = "CHARGING (Low Price)";
                strategyText.style.color = "#155724";
            } else if (diff < -5) {
                statusCard.className = "status-card discharge";
                strategyText.innerText = "DISCHARGING (Peak Shaving)";
                strategyText.style.color = "#721c24";
            } else {
                statusCard.className = "status-card";
                strategyText.innerText = "STANDBY";
                strategyText.style.color = "#333";
            }
        }

        // --- 4. 绘图函数 ---
        
        // 画电池
        function drawBattery(soc, action) {
            let ctx = batCtx;
            ctx.clearRect(0, 0, 300, 280);
            
            // 电池壳
            ctx.lineWidth = 6;
            ctx.strokeStyle = "#444";
            ctx.strokeRect(80, 50, 140, 200);
            ctx.fillStyle = "#444";
            ctx.fillRect(120, 35, 60, 15); // 头

            // 电量柱
            let h = 180 * soc;
            let y = 240 - h;
            let color = soc > 0.3 ? "#28a745" : "#dc3545";
            ctx.fillStyle = color;
            ctx.fillRect(90, y, 120, h);

            // 百分比
            ctx.fillStyle = "#000";
            ctx.font = "bold 24px Arial";
            ctx.textAlign = "center";
            ctx.fillText(Math.round(soc*100) + "%", 150, 160);

            // 动态箭头
            if (action > 5) { // 充电
                ctx.fillStyle = "#28a745";
                ctx.beginPath();
                ctx.moveTo(150, 270); ctx.lineTo(130, 290); ctx.lineTo(170, 290);
                ctx.fill();
                ctx.font = "bold 16px Arial"; ctx.fillText("Grid → Battery", 150, 310);
            } else if (action < -5) { // 放电
                ctx.fillStyle = "#dc3545";
                ctx.beginPath();
                ctx.moveTo(150, 30); ctx.lineTo(130, 10); ctx.lineTo(170, 10);
                ctx.fill();
                ctx.font = "bold 16px Arial"; ctx.fillText("Battery → House", 150, 20);
            }
        }

        // 画电价图
        function drawPriceChart(ctx, w, h) {
            ctx.clearRect(0, 0, w, h);
            
            // 背景区域 (绿色低价，红色高价)
            let xGreenEnd = (6 * RESOLUTION) * (w/TOTAL_POINTS);
            let xRedStart = (14 * RESOLUTION) * (w/TOTAL_POINTS);
            let xRedEnd = (20 * RESOLUTION) * (w/TOTAL_POINTS);

            ctx.fillStyle = "#e6f4ea"; ctx.fillRect(0, 0, xGreenEnd, h); // Charge Zone
            ctx.fillStyle = "#ffe6e6"; ctx.fillRect(xRedStart, 0, xRedEnd-xRedStart, h); // Discharge Zone

            // 曲线
            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.strokeStyle = "#555";
            for(let i=0; i<TOTAL_POINTS; i++) {
                let x = i * (w/TOTAL_POINTS);
                let y = map(priceData[i], 0, 0.6, h, 0);
                if (i==0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // 当前时间线
            let nowX = currentIndex * (w/TOTAL_POINTS);
            ctx.beginPath(); ctx.moveTo(nowX, 0); ctx.lineTo(nowX, h); 
            ctx.strokeStyle = "#007bff"; ctx.lineWidth = 2; ctx.stroke();
        }

        // 画负荷图 (最重要：削峰可视化)
        function drawLoadChart(ctx, w, h) {
            ctx.clearRect(0, 0, w, h);
            
            // 1. 原始负荷 (灰色虚线)
            ctx.beginPath();
            ctx.strokeStyle = "#aaa"; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
            for(let i=0; i<TOTAL_POINTS; i++) {
                let x = i * (w/TOTAL_POINTS);
                let y = map(loadData[i], 0, 200, h, 0);
                if (i==0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke(); ctx.setLineDash([]);

            // 2. 优化后负荷 (蓝色实线)
            ctx.beginPath();
            ctx.strokeStyle = "#007bff"; ctx.lineWidth = 3;
            for(let i=0; i<TOTAL_POINTS; i++) {
                let x = i * (w/TOTAL_POINTS);
                let y = map(gridLoad[i], 0, 200, h, 0);
                if (i==0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // 3. 填充削峰区域 (橙色)
            ctx.fillStyle = "rgba(255, 165, 0, 0.5)";
            ctx.beginPath();
            for(let i=0; i<TOTAL_POINTS; i++) {
                let x = i * (w/TOTAL_POINTS);
                let yOld = map(loadData[i], 0, 200, h, 0);
                let yNew = map(gridLoad[i], 0, 200, h, 0);
                if (gridLoad[i] < loadData[i]) { // 放电时
                     if(i==0) ctx.moveTo(x, yOld);
                     ctx.lineTo(x, yOld); ctx.lineTo(x, yNew);
                }
            }
            ctx.fill();

            // 4. 填充充电区域 (绿色)
            ctx.fillStyle = "rgba(40, 167, 69, 0.3)";
            ctx.beginPath();
            for(let i=0; i<TOTAL_POINTS; i++) {
                let x = i * (w/TOTAL_POINTS);
                let yOld = map(loadData[i], 0, 200, h, 0);
                let yNew = map(gridLoad[i], 0, 200, h, 0);
                if (gridLoad[i] > loadData[i]) { // 充电时
                     if(i==0) ctx.moveTo(x, yOld);
                     ctx.lineTo(x, yOld); ctx.lineTo(x, yNew);
                }
            }
            ctx.fill();

            // 当前时间线
            let nowX = currentIndex * (w/TOTAL_POINTS);
            ctx.beginPath(); ctx.moveTo(nowX, 0); ctx.lineTo(nowX, h); 
            ctx.strokeStyle = "#007bff"; ctx.lineWidth = 2; ctx.stroke();
        }

        function map(v, i1, i2, o1, o2) { return o1 + (o2 - o1) * ((v - i1) / (i2 - i1)); }

        // 启动
        loop();
    </script>
</body>
</html>
