<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>RL-HVAC Direct Power Control Demo</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .dashboard { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; gap: 20px; max-width: 900px; width: 100%; }
        .room-view { width: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #eee; padding-right: 20px; }
        .charts-view { flex: 1; }
        /* 修改点：Canvas 高度样式适应 */
        canvas { border: 1px solid #e0e0e0; background: #fafafa; border-radius: 8px; margin-bottom: 10px; display: block; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; width: 100%; margin-top: 20px; }
        button:hover { background: #0056b3; }
        button.occupied { background: #28a745; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; margin-bottom: 10px; }
        .status-eco { background: #e6f4ea; color: #1e8e3e; }
        .status-comfort { background: #e8f0fe; color: #1967d2; }
        h3 { margin: 10px 0 5px 0; color: #333; font-size: 16px; }
        .legend { font-size: 12px; color: #666; display: flex; gap: 15px; margin-bottom: 5px; }
        .dot { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

    <h2>RL-HVAC Control Strategy Demo</h2>
    <div class="dashboard">
        <div class="room-view">
            <div id="modeBadge" class="status-badge status-eco">MODE: ECO (Energy Saving)</div>
            <canvas id="roomCanvas" width="250" height="250"></canvas>
            
            <div style="text-align: left; width: 100%; margin-top: 10px; font-size: 14px;">
                <p><strong>Current State:</strong></p>
                <p>Occupancy: <span id="occText">NO</span></p>
                <p>Reward Weight (Comfort): <span id="weightText">Low</span></p>
            </div>

            <button id="toggleBtn" onclick="toggleOccupancy()">Simulate Person Entering</button>
        </div>

        <div class="charts-view">
            <h3>Temperature (°C)</h3>
            <div class="legend">
                <span><span class="dot" style="background:#ff4444"></span>Indoor Temp</span>
                <span><span class="dot" style="background:#ddd; border:1px dashed #999"></span>Comfort Range</span>
            </div>
            <canvas id="tempChart" width="500" height="150"></canvas>

            <h3>HVAC Power Output (0% - 100%)</h3>
            <div class="legend">
                <span><span class="dot" style="background:#007bff"></span>Direct Power Action</span>
            </div>
            <canvas id="powerChart" width="500" height="150"></canvas>
        </div>
    </div>

    <script>
        // --- 仿真参数 ---
        let isOccupied = false;
        let time = 0;
        
        // 物理环境参数
        let indoorTemp = 26.0;
        let ambientTemp = 33.0; // 修改点：外界温度调高，增加热负荷
        const coolingPowerMax = 0.25; // 修改点：空调制冷能力调高，匹配热负荷
        const heatLeakage = 0.01; // 修改点：隔热变差，让温度回升更快，对比更明显
        
        // RL 控制参数
        let targetTemp = 24.0;
        let currentPower = 0.0;
        
        // 舒适区边界
        let upperLimit = 28.0;
        let lowerLimit = 20.0;

        // 数据记录
        const maxDataPoints = 200;
        let tempData = new Array(maxDataPoints).fill(26);
        let powerData = new Array(maxDataPoints).fill(0);
        let limitData = new Array(maxDataPoints).fill({upper: 28, lower: 20});

        // Canvas Contexts
        const roomCtx = document.getElementById('roomCanvas').getContext('2d');
        const tempCtx = document.getElementById('tempChart').getContext('2d');
        const powerCtx = document.getElementById('powerChart').getContext('2d');

        // --- 核心逻辑循环 ---
        function updateSimulation() {
            // 1. 物理模拟
            // 热量自然流入
            indoorTemp += (ambientTemp - indoorTemp) * heatLeakage;
            // 空调降温
            indoorTemp -= currentPower * coolingPowerMax;
            // 随机扰动
            indoorTemp += (Math.random() - 0.5) * 0.05;

            // 2. RL Agent 模拟
            if (isOccupied) {
                // [有人模式]
                let error = indoorTemp - targetTemp;
                
                // PID/RL 模拟逻辑：需要一定的功率来维持热平衡
                // 稳态功率 = heatLeakage * (33 - 24) / coolingPowerMax ≈ 0.36 (36%)
                let desiredPower = (error * 1.5) + 0.35; 
                
                // 平滑约束
                if (desiredPower > currentPower + 0.03) currentPower += 0.03;
                else if (desiredPower < currentPower - 0.03) currentPower -= 0.03;
                else currentPower = desiredPower;

                upperLimit = 24.5;
                lowerLimit = 23.5;
            } else {
                // [无人模式]
                upperLimit = 28.0;
                lowerLimit = 20.0;
                
                if (indoorTemp > upperLimit - 0.2) {
                    currentPower = 0.2; // 间歇性开启防止过热
                } else {
                    currentPower = 0.0; 
                }
            }

            // 物理截断 (0.0 - 1.0)
            currentPower = Math.max(0, Math.min(1, currentPower));

            // 3. 更新数据
            tempData.push(indoorTemp);
            tempData.shift();
            powerData.push(currentPower);
            powerData.shift();
            limitData.push({upper: upperLimit, lower: lowerLimit});
            limitData.shift();

            time++;
        }

        // --- 绘图逻辑 ---
        function draw() {
            // 清空
            roomCtx.clearRect(0, 0, 250, 250);
            tempCtx.clearRect(0, 0, 500, 150);
            powerCtx.clearRect(0, 0, 500, 150);

            // --- 1. 画房间 ---
            // 简单画个房子
            roomCtx.lineWidth = 2;
            roomCtx.strokeStyle = "#666";
            roomCtx.strokeRect(40, 60, 170, 130); // 墙
            // 地板
            roomCtx.fillStyle = "#ddd";
            roomCtx.fillRect(40, 190, 170, 10);

            // 空调
            roomCtx.fillStyle = currentPower > 0.05 ? "#007bff" : "#ccc";
            roomCtx.fillRect(100, 60, 50, 15);
            
            // 冷气可视化 (根据功率大小变化)
            if (currentPower > 0.05) {
                roomCtx.fillStyle = `rgba(0, 123, 255, ${currentPower * 0.6})`; // 透明度随功率变
                roomCtx.beginPath();
                roomCtx.moveTo(105, 75);
                roomCtx.lineTo(80, 180);
                roomCtx.lineTo(170, 180);
                roomCtx.lineTo(145, 75);
                roomCtx.fill();
            }

            // 人
            if (isOccupied) {
                drawPerson(roomCtx, 125, 150);
                roomCtx.fillStyle = "#28a745";
                roomCtx.font = "bold 16px Arial";
                roomCtx.fillText("OCCUPIED", 85, 230);
            } else {
                roomCtx.fillStyle = "#999";
                roomCtx.font = "italic 16px Arial";
                roomCtx.fillText("UNOCCUPIED", 75, 230);
            }

            // --- 2. 画温度曲线 ---
            drawGrid(tempCtx, 500, 150, 20, 32, "°C");
            
            // 舒适区背景
            tempCtx.fillStyle = isOccupied ? "rgba(0, 123, 255, 0.15)" : "rgba(40, 167, 69, 0.1)";
            tempCtx.beginPath();
            let chartH = 150;
            // 上边界
            tempCtx.moveTo(0, map(limitData[0].upper, 20, 32, chartH, 0));
            for (let i = 0; i < maxDataPoints; i++) {
                tempCtx.lineTo(i * (500/maxDataPoints), map(limitData[i].upper, 20, 32, chartH, 0));
            }
            // 下边界
            for (let i = maxDataPoints - 1; i >= 0; i--) {
                tempCtx.lineTo(i * (500/maxDataPoints), map(limitData[i].lower, 20, 32, chartH, 0));
            }
            tempCtx.fill();

            // 实际温度
            tempCtx.beginPath();
            tempCtx.strokeStyle = "#ff4444";
            tempCtx.lineWidth = 3;
            for (let i = 0; i < maxDataPoints; i++) {
                let y = map(tempData[i], 20, 32, chartH, 0);
                let x = i * (500/maxDataPoints);
                if (i===0) tempCtx.moveTo(x, y);
                else tempCtx.lineTo(x, y);
            }
            tempCtx.stroke();

            // --- 3. 画功率曲线 ---
            // 修改点：Y轴显示 0-100%
            drawGrid(powerCtx, 500, 150, 0, 100, "%");
            
            powerCtx.beginPath();
            powerCtx.strokeStyle = "#007bff";
            powerCtx.lineWidth = 2;
            powerCtx.fillStyle = "rgba(0, 123, 255, 0.2)";
            powerCtx.moveTo(0, 150);
            for (let i = 0; i < maxDataPoints; i++) {
                // 修改点：数据 0-1 映射到 0-100 显示
                let valPercent = powerData[i] * 100;
                let y = map(valPercent, 0, 100, 150, 0);
                let x = i * (500/maxDataPoints);
                powerCtx.lineTo(x, y);
            }
            powerCtx.lineTo(500, 150);
            powerCtx.fill();
            powerCtx.stroke();

            requestAnimationFrame(animate);
        }

        // --- 工具 ---
        function animate() {
            updateSimulation();
            draw();
        }

        function toggleOccupancy() {
            isOccupied = !isOccupied;
            const btn = document.getElementById('toggleBtn');
            const badge = document.getElementById('modeBadge');
            const occText = document.getElementById('occText');
            const weightText = document.getElementById('weightText');

            if (isOccupied) {
                btn.innerText = "Simulation: Person Leaves Room";
                btn.className = "occupied";
                badge.innerText = "MODE: COMFORT (Precision Control)";
                badge.className = "status-badge status-comfort";
                occText.innerText = "YES";
                occText.style.color = "green";
                weightText.innerText = "High (Strict)";
            } else {
                btn.innerText = "Simulation: Person Enters Room";
                btn.className = "";
                badge.innerText = "MODE: ECO (Energy Saving)";
                badge.className = "status-badge status-eco";
                occText.innerText = "NO";
                occText.style.color = "gray";
                weightText.innerText = "Low";
            }
        }

        function drawPerson(ctx, x, y) {
            ctx.fillStyle = "#333";
            ctx.beginPath();
            ctx.arc(x, y-15, 10, 0, Math.PI * 2); // Head
            ctx.fill();
            ctx.fillRect(x - 12, y, 24, 30); // Body
        }

        function map(value, inMin, inMax, outMin, outMax) {
            return (value - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
        }

        function drawGrid(ctx, w, h, min, max, unit) {
            ctx.strokeStyle = "#eee";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.fillStyle = "#666";
            ctx.font = "11px Arial";
            
            // 画4条横线
            for (let i = 0; i <= 4; i++) {
                let y = i * (h/4);
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                
                // 计算数值标签
                let val = max - (i/4)*(max-min);
                // 简单的四舍五入
                val = Math.round(val);
                ctx.fillText(val + unit, 5, y - 4);
            }
            ctx.stroke();
        }

        animate();

    </script>
</body>
</html>